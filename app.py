import streamlit as st import pandas as pd import numpy as np import easyocr from openpyxl import load_workbook from openpyxl.styles import PatternFill, Font from PIL import Image, ImageEnhance import re import os import shutil # Colores para Excel COLOR_VERDE = PatternFill(start_color="00FF00", end_color="00FF00", fill_type="solid") COLOR_MORADO = PatternFill(start_color="800080", end_color="800080", fill_type="solid") st.title("üìö Inventario Biblioteca UCC - Sede Medell√≠n") st.write("La aplicaci√≥n detecta c√≥digos autom√°ticamente y actualiza el Excel sin necesidad de presionar botones.") EXCEL_PATH = "inventario.xlsx" BACKUP_PATH = "inventario_backup.xlsx" # Funci√≥n para crear backup def crear_backup(): if os.path.exists(EXCEL_PATH): shutil.copy(EXCEL_PATH, BACKUP_PATH) if not os.path.exists(EXCEL_PATH): st.error("No se encontr√≥ 'inventario.xlsx'. Sube tu inventario inicial.") uploaded_file = st.file_uploader("Sube el inventario inicial", type=["xlsx"]) if uploaded_file: with open(EXCEL_PATH, "wb") as f: f.write(uploaded_file.getbuffer()) st.success("Inventario cargado exitosamente. Recarga la p√°gina para comenzar.") st.stop() wb = load_workbook(EXCEL_PATH) sheet = wb.active df = pd.read_excel(EXCEL_PATH) codigo_columna = None for col in df.columns: if "codigo" in col.lower(): codigo_columna = col break if not codigo_columna: st.error("No existe una columna llamada 'codigo' en el archivo.") st.stop() codigo_a_fila = {str(row[codigo_columna]).strip(): idx + 2 for idx, row in df.iterrows()} @st.cache_resource def cargar_ocr(): return easyocr.Reader(['es', 'en']) reader = cargar_ocr() st.subheader("Escanea el c√≥digo") img_file = st.camera_input("Toma una foto del c√≥digo") codigo_detectado = None if img_file: img = Image.open(img_file) img_array = np.array(img) # Preprocesar imagen para mejor OCR img_gray = img.convert('L') img_enhanced = ImageEnhance.Contrast(img_gray).enhance(2.0) img_array = np.array(img_enhanced) textos = reader.readtext(img_array, detail=0) frases_prohibidas = [ "sistemadeinformacionbibliografico", "sistemadeinformacion", "bibliografico", "biblioteca", "universidad", "cooperativa", "colombia" ] posibles_codigos = [] for t in textos: t_limpio = t.lower().replace(" ", "").replace("-", "").strip() if any(frase in t_limpio for frase in frases_prohibidas): continue if re.fullmatch(r"b\d{6,8}", t_limpio): posibles_codigos.append(t_limpio.upper()) continue if t_limpio.startswith("b") and len(t_limpio) >= 7: posibles_codigos.append(t_limpio.upper()) if posibles_codigos: codigo_detectado = max(posibles_codigos, key=len) st.success(f"C√≥digo detectado: **{codigo_detectado}**") if codigo_detectado in codigo_a_fila: fila = codigo_a_fila[codigo_detectado] celda = f"A{fila}" sheet[celda].fill = COLOR_VERDE sheet[celda].font = Font(bold=True) st.success(f"‚úî C√≥digo {codigo_detectado} encontrado y marcado en verde.") else: nueva_fila = sheet.max_row + 1 sheet[f"A{nueva_fila}"] = codigo_detectado sheet[f"A{nueva_fila}"].fill = COLOR_MORADO sheet[f"A{nueva_fila}"].font = Font(bold=True) # Actualizar el mapeo para futuros escaneos codigo_a_fila[codigo_detectado] = nueva_fila st.warning(f"‚ûï C√≥digo nuevo agregado: {codigo_detectado}") wb.save(EXCEL_PATH) # Crear backup crear_backup() else: st.warning("No se encontr√≥ un c√≥digo v√°lido en la imagen.") st.subheader("Ingresar c√≥digo manualmente") codigo_manual = st.text_input("Escribe el c√≥digo si no puedes escanearlo:") if codigo_manual: codigo_manual = codigo_manual.strip().upper() if codigo_manual in codigo_a_fila: fila = codigo_a_fila[codigo_manual] celda = f"A{fila}" sheet[celda].fill = COLOR_VERDE sheet[celda].font = Font(bold=True) st.success(f"‚úî C√≥digo {codigo_manual} encontrado y marcado en verde.") else: nueva_fila = sheet.max_row + 1 sheet[f"A{nueva_fila}"] = codigo_manual sheet[f"A{nueva_fila}"].fill = COLOR_MORADO sheet[f"A{nueva_fila}"].font = Font(bold=True) codigo_a_fila[codigo_manual] = nueva_fila st.warning(f"‚ûï C√≥digo nuevo agregado manualmente: {codigo_manual}") wb.save(EXCEL_PATH) crear_backup() st.subheader("Inventario actualizado") st.dataframe(pd.read_excel(EXCEL_PATH)) with open(EXCEL_PATH, "rb") as f: st.download_button("Descargar inventario actualizado", f, file_name="inventario_actualizado.xlsx") # Funci√≥n para crear backup def crear_backup(): if os.path.exists(EXCEL_PATH): shutil.copy(EXCEL_PATH, BACKUP_PATH)
